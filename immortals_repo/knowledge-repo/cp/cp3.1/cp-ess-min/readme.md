# IMMoRTALS Phase III CP I Exemplar Software System (CP3.1-ESS)

## Adapting software systems to schema changes
Authored by
<span style="color:blue">Jacob Staples (*jstaples@securboration.com*)</span>

### Purpose of this document
This document provides an overview of an Exemplar Software System (ESS) developed for the purpose of IMMoRTALS Phase III CP1 evaluation.

### Purpose of the ESS
The ESS demonstrates problems that arise when assumptions made by application developers about concerns that transcend the application boundary (in this case, schema compliance) are baked-in to application code and subsequently broken by ecosystem changes (in this case, schema evolution).

**NOTE**: The ESS will build without modification but in its default state *does not provide any evolutionary pressure*.  However, it can be readily modified to introduce varying degrees of pressure.

### ESS project structure 

* **schema** contains the schemas to be used in the ESS build.  The schemas in this directory represent the assumptions made by application developers at some point in time prior to evaluation.
  * *schema/client* represents the assumptions made by developers of the client.  By default, the is MDL_v0_8_17.xsd (derived from SwRI's MDL_v0_8_17_with_Examples.zip).
  * *schema/server* represents the assumptions made by developers of the server.  By default, the is MDL_v0_8_17.xsd (derived from SwRI's MDL_v0_8_17_with_Examples.zip).
  * *schema/datasource* represents the assumptions made by datasource authors.  By default, this is MDL_v0_8_17.xsd.  Note that all messages ingested by the client from *datasource* must conform to this schema.
* **schema-code** contains code autogenerated from *schema/client* and *schema/server* during the ESS build.  Although autogenerated to facilitate evaluation, this code represents the assumptions made by application developers.  The goal of the CP is to modify data as it enters/exits an application such that these code units don't break.
  * *schema-code/client* contains [autogenerated Java types](http://www.mojohaus.org/jaxb2-maven-plugin/Documentation/v2.2/) derived from schema/client
  * *schema-code/server* contains autogenerated Java types derived from schema/server
* **server** is a Java [spring-boot](http://spring.io/projects/spring-boot) app that runs an [embedded](https://docs.spring.io/spring-boot/docs/current/reference/html/howto-embedded-web-servers.html) [Tomcat](http://tomcat.apache.org/) instance that listens for [SOAP/XML](http://webreference.com/authoring/web_service/index-2.html) messages containing schema/server-compliant documents
* **client** is a Java spring-boot client that converses with a server using schema/client-conformant documents
* **datasource** is a bag of documents conformant to *schema/datasource* that is to be ingested by the client and transmitted to the server
* **etc** contains reference data provided by SwRI.  This directory is not read/written during evaluation.
  * *etc/schemas/v1* contains a WSDL with dependencies on MDL_v0_8_17.xsd.  This was derived from SwRI's MDL_v0_8_17_with_Examples.zip.
  * *etc/schemas/v2* contains a WSDL with dependencies on MDL_v0_8_19.xsd.  This was derived from SwRI's MDL_v0_8_19_with_Examples.zip.
  * *etc/schemas/v3* currently a copy of etc/schema/v2
  * *etc/messages/v1* contains several representative XML messages conformant with MDL_v0_8_17.xsd.  These were copied from SwRI's MDL_v0_8_17_with_Examples.zip. <span color="red">**NOTE** that one of the original XML documents, VariableLengthPackages.xml, has validation issues and has been disabled for the time being.</span>
  * *etc/messages/v2* contains several representative XML messages conformant with MDL_v0_8_19.xsd.  These were copied from SWRI's MDL_v0_8_19_with_Examples.zip.
  * *etc/messages/v3* currently a copy of etc/messages/v3

  
### Architecture and evolutionary pressure

The dataflows along which adaptation may need to occur are called out in numbered edges below:
```
                                  SOAP/XML
                                  messages
                      /--------\             /--------\ 
                      |        | ====(2a)==> |        |  
[documents] ---(1)--> | CLIENT |             | SERVER |
                      |        | <==(2b)==== |        |
                      \--------/             \--------/
```

  1) This dataflow involves the client reading MDL documents from the local file system of the platform on which it executes.  See client:com.securboration.client.ClientRunner (line 101).  If the schema version of the documents differs from the client, adaptation will be required along dataflow 1.  
  2) This dataflow involves (2a) the client transmitting an MDL document to the server and (2b) receiving a response.  See client:com.securboration.client.MessageListenerClient (line 44).  If the schema version of the client differs from that of the server, adaptation will be required along 2a and 2b.
  
### Evolutionary pressure
Evolutionary pressure arises when 
  1) Documents read by the client from a datasource (a directory on the file system) are non-compliant with the version for which the client was explicitly coded.
  2) Documents transmitted to the server from the client are non-compliant with the version expected by the server.
  3) Documents received from the server by the client are non-compliant with the version expected by the client.

By default, there is no evolutionary pressure present because assumptions made by authors of the client, authors of the server, and authors of the datasource are serendipitously aligned at MDL_v0_8_17.

Note that, depending upon the configuration of the ESS, several pressures may be present simultaneously.  The following degrees of freedom are defined for the CP:
  1) **SCHEMA_CLIENT** is the schema version assumed to exist at the time the client application was authored.  The schema comprises one or more MDL XSDs placed in in *schema/client* and referenced by *schema/client/MessageListenerSchema.xsd*.
  2) **SCHEMA_SERVER** is the schema version that exists at the time the server was refactored.  The schema comprises one or more MDL XSDs placed in in *schema/server* and referenced by *schema/server/MessageListenerSchema.xsd*.
  3) **SCHEMA_DATASOURCE** is the schema version that existed at the time an XML document library (later ingested by the client) was created.  The schema comprises one or more MDL XSDs.  Note that no code types are autogenerated from this schema.  The XSDs must nonetheless be present at *schema/datasource* (they are used during analysis).
  4) **DATASOURCE_DOCUMENTS** is a bag of XML documents conformant to *SCHEMA_DATASOURCE*

In the *etc* directory, the following canned values are defined for the parameters above:
  1) **SCHEMA_CLIENT**: v1 (MDL_v0_8_17), v2 (MDL_v0_8_19)
  2) **SCHEMA_SERVER**: v1, v2
  3) **SCHEMA_DATASOURCE**: v1, v2
  4) **DATASOURCE_DOCUMENTS**: There are 16 v1 documents in *messages/v1* (one of the 17 original documents provided by SwRI does not validate and is disabled), 17 v2 documents in *messages/v2*

There are 8 unique {SCHEMA_CLIENT, SCHEMA_SERVER, SCHEMA_DATASOURCE} tuples.  Exactly 2 of these (those in which the client, server, and datasource versions are equal) will not require adaptation under any circumstance.  The remaining 6 will require varying degrees of adaptation, qualified by the complexity of the CLIENT_INPUT_MESSAGES set.

A deeper exploration of the adaptation space is possible by using a subset of the v1 and v2 document sets.  This increases the size of the configuration space by a factor of roughly 2^33.  More, and more complex, documents makes for a more difficult challenge problem because during adaptation, our system will learn the portion of the XML Schema actually used by the app as it traverses the datasource messages.  More complex XML documents will therefore result in more involved adaptation (a very simple document, for example, might require no adaptation under any of the possible configurations).

Even more exploration beyond the {v1,v2} schema enumeration is possible if the CP evaluator defines custom documents not present in the original dataset or uses a schema other than v1 or v2.  We encourage this kind of exploration because it showcases the technology.


### Building the ESS

#### Prerequisites
  1) Gradle (tested with 4.9) (validate with gradle -version) **OR** Maven (tested with version 3.3.9) (validate with `mvn -version`)
  2) Java (tested with 1.8.0_161).  Validate with `java -version`
  3) Connectivity to the Internet.  This is a build-only requirement--executing the ESS does not require Internet access.
  4) The ESS codebase in a directory subsequently referred to as `$ESS_HOME`

#### Procedure
All commands are executed from `$ESS_HOME`

To build the software using Gradle, execute the following command:
```
	gradle clean build
```

To build the software using Maven, execute the following command:
```
	mvn clean install
```

**NOTE** that your first build may be quite time consuming as dependencies are downloaded and cached (subsequent builds should be much faster).

### Running the ESS
All commands are executed from `$ESS_HOME`

#### Prerequisites
  1) Java 8 (tested with 1.8.0_161).  Java 9 and Java 10 are not currently supported.  Validate with `java -version`
  2) You must have previously built the ESS

#### Running the server
To run the server:
```
	java -jar ./server/target/immortals-cp3.1-server-1.0.0.jar
```

NOTE: By default the server starts on port 8080.  If another port is desired, it can be specified like so:
```
	java -Dserver.port=8081 -jar ./server/target/immortals-cp3.1-server-1.0.0.jar
```

#### Running the client

To run the client (with v1 inputs):
```
	java -DREPORT_DIR=./report -DSERVER_ENDPOINT_URL=http://localhost:8080/ws -jar ./clients/v1/target/immortals-cp3.1-client-1.0.0.jar
```

The datasource can be specified as follows:
```
	java -DREPORT_DIR=./report -DMESSAGES_TO_SEND_DIR=./etc/messages/v1 -DSERVER_ENDPOINT_URL=http://localhost:8080/ws -jar ./clients/v1/target/immortals-cp3.1-client-1.0.0.jar
```

Note that the client port specified in SERVER_ENDPOINT_URL must be the same as the one used by the server.

The MESSAGES_TO_SEND_DIR property specifies a directory containing XML documents compliant to V1, V2, or V3 as specified for the client during the build (the use of a directory containing a V1 document with a V2 client would be considered an incorrect use of the software and *not* evolutionary pressure).  The client traverses this directory and recursively visits any XML documents found.  Each document is modified by the client and transmitted to the server (note that for builds with a different client and server version, this will cause the code to break).  Each document is treated as a separate test case and the number of passing test cases are emitted to ./report (specified by -DREPORT_DIR) after processing all documents.

The SERVER_ENDPOINT_URL property specifies the endpoint of the server.  You may need to modify the host and/or port.

#### Sample report output with a v1-compliant client, v1 datasource, and v1-compliant server (everything works)

```
server URI	http://localhost:8080/ws
server ping (millis)	7
expected MDL schema version	MDL_v0_8_17.xsd
starting test run with input dir	./messages/v1
test1 input	./messages/v1/AssetAssociations.xml
test1 result	test PASSED
test2 input	./messages/v1/Bandpass-Measurement.xml
test2 result	test PASSED
test3 input	./messages/v1/Data-Stream-Ch10.xml
test3 result	test PASSED
test4 input	./messages/v1/Extract-Bus-Measurements.xml
test4 result	test PASSED
test5 input	./messages/v1/Mapping-24bit-measurement-into-16bit-fields.xml
test5 result	test PASSED
test6 input	./messages/v1/Measurements-and-Data-Operations.xml
test6 result	test PASSED
test7 input	./messages/v1/Measurements-with-TMATS.xml
test7 result	test PASSED
test8 input	./messages/v1/MissionQoS.xml
test8 result	test PASSED
test9 input	./messages/v1/MultipleAppsPerNetworkNode.xml
test9 result	test PASSED
test10 input	./messages/v1/Network-Example.xml
test10 result	test PASSED
test11 input	./messages/v1/PackagingMeasurements.xml
test11 result	test PASSED
test12 input	./messages/v1/PackagingPCMStream.xml
test12 result	test PASSED
test13 input	./messages/v1/PCM-Example.xml
test13 result	test PASSED
test14 input	./messages/v1/PCM-with-TMATS.xml
test14 result	test PASSED
test15 input	./messages/v1/Select-Bus-Measurements.xml
test15 result	test PASSED
test16 input	./messages/v1/Standalone-Example.xml
test16 result	test PASSED
done with tests	
# tests performed	16
# tests that passed	16
# tests that failed	0
pass rate	1.0
fail rate	0.0
score	1.0
overall elapsed time (millis)	5562
```







